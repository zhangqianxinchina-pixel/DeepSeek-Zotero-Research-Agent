name: Weekly Research Monitor

on:
  schedule:
    - cron: '0 0 * * 1'
  workflow_dispatch: 

jobs:
  run-research-agent:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        pip install requests pyzotero openai python-dotenv
        
    - name: Run Agent
      env:
        ZOTERO_API_KEY: ${{ secrets.ZOTERO_API_KEY }}
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        MAIL_HOST: ${{ secrets.MAIL_HOST }}
        MAIL_USER: ${{ secrets.MAIL_USER }}
        MAIL_PASS: ${{ secrets.MAIL_PASS }}
        MAIL_RECEIVER: ${{ secrets.MAIL_RECEIVER }}
        S2_API_KEY: ${{ secrets.S2_API_KEY }}
      run: python main.py

    - name: Commit and Push History
      run: |
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"
        
        if [ -f sent_history.json ]; then
          echo "✅ Found history file. Committing..."
          
          git add -f sent_history.json
          
          git commit -m "Update sent history [skip ci]" || echo "No changes to commit"
          git push
        else
          echo "⚠️ No history file found (No email sent today). Skipping commit."
        fi
